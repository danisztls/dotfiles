#!/usr/bin/env bash
# Run a command on all Git repos under a path

# usage: git-all <action> <path-to-parent-dir> (optional)
# e.g.: git-all git-pull-safe ~

[ "$1" ] && _command="$1" || exit 1
[ "$2" ] && _path="$2"

# Change dir to inputted path if valid
if [ -d "$_path" ]; then
  cd "$_path" || exit
fi

mapfile -t repos < <(\
                     fd -t d --unrestricted '\.git$' \
                     --exclude "**/vim/plugged/" \
                     --exclude "**/zinit/plugins/" \
                     --exclude "**/Trash/" \
                     --exclude ".cache" \
                     --exclude ".emacs.d/" \
                     --exclude ".config/emacs/" \
                     --exclude ".local/share/cargo/" \
                     --exclude ".local/share/docker/" \
                     --exclude ".local/share/go/" \
                    )

for repo in "${repos[@]}"; do
  # trim .git/
  path="${repo%.git/}"

  # run one by one
  # sem -j+0 "$_command" "$path"

  # run in parallel
  sem -j 4 "$_command" "$path"

  # NOTE: GitHub limit is 4 simultaneous connections
done

# wait for tasks to finish
sem --wait
